{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ post.title }} - GRTTS Blog{% endblock %}

{% block extra_css %}
<style>
    .blog-content {
        font-size: 1.1rem;
        line-height: 1.8;
    }
    .blog-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 20px 0;
    }
    .blog-content h2 {
        color: #2d5a3b;
        margin-top: 30px;
    }
    .blog-content h3 {
        color: #2d5a3b;
        margin-top: 25px;
    }
    
    /* Gallery Styles */
    .media-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    .gallery-item {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background: white;
    }
    .gallery-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(45, 90, 59, 0.2);
    }
    .gallery-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        cursor: pointer;
        transition: opacity 0.3s ease;
    }
    .gallery-image:hover {
        opacity: 0.9;
    }
    .gallery-caption {
        padding: 12px;
        font-size: 0.9rem;
        color: #2d5a3b;
        background: white;
        border-top: 1px solid #f0f0f0;
    }
    
    /* Lightbox Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        padding-top: 50px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
    }
    .modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 80%;
    }
    .modal-caption {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
        text-align: center;
        color: #ccc;
        padding: 10px 0;
        font-size: 1rem;
    }
    .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    .close:hover {
        color: #ffd966;
    }
    
    /* Video Styles */
    .video-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        margin: 20px 0;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 10px;
    }
    .video-item {
        margin-bottom: 30px;
    }
    .video-title {
        color: #2d5a3b;
        margin-bottom: 5px;
    }
    .video-description {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 10px;
    }
    
    /* File Download Styles */
    .files-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin: 30px 0;
    }
    .file-download {
        display: flex;
        align-items: center;
        padding: 15px;
        background: white;
        border-radius: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    .file-download:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(45, 90, 59, 0.1);
        border-color: #ffd966;
    }
    .file-icon {
        font-size: 2.5rem;
        margin-right: 15px;
        min-width: 50px;
        text-align: center;
    }
    .file-icon i {
        color: #2d5a3b;
    }
    .file-info {
        flex-grow: 1;
    }
    .file-title {
        font-weight: 600;
        color: #2d5a3b;
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    .file-meta {
        font-size: 0.85rem;
        color: #666;
    }
    .file-meta span {
        margin-right: 10px;
    }
    .file-meta i {
        color: #ffd966;
        margin-right: 3px;
    }
    .download-btn {
        padding: 8px 20px;
        background: #2d5a3b;
        color: white;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }
    .download-btn:hover {
        background: #1e3c2c;
        color: white;
        transform: scale(1.05);
    }
    .download-btn i {
        font-size: 0.9rem;
    }
    
    /* File type specific colors */
    .file-icon .fa-file-pdf { color: #dc3545; }
    .file-icon .fa-file-word { color: #2b5797; }
    .file-icon .fa-file-excel { color: #217346; }
    .file-icon .fa-file-powerpoint { color: #d24726; }
    .file-icon .fa-file-alt { color: #6c757d; }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .media-gallery {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .gallery-image {
            height: 150px;
        }
        .file-download {
            flex-wrap: wrap;
        }
        .download-btn {
            margin-top: 10px;
            width: 100%;
            justify-content: center;
        }
        .file-icon {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'blog:post_list' %}" style="color: #2d5a3b;">Blog</a></li>
            {% if post.category %}
            <li class="breadcrumb-item"><a href="{% url 'blog:category_list' post.category.slug %}" style="color: #2d5a3b;">{{ post.category.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active">{{ post.title }}</li>
        </ol>
    </nav>
    
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Post Header -->
            <header class="mb-4">
                <h1 class="display-4" style="color: #2d5a3b;">{{ post.title }}</h1>
                
                <div class="text-muted mb-3">
                    <i class="fas fa-calendar"></i> {{ post.published_date|date:"F j, Y" }} |
                    <i class="fas fa-user"></i> {{ post.author.get_full_name|default:post.author.username }} |
                    <i class="fas fa-eye"></i> {{ post.views }} views
                </div>
                
                {% if post.category %}
                <div class="mb-3">
                    <span class="badge" style="background-color: #ffd966; color: #2d5a3b;">{{ post.category.name }}</span>
                </div>
                {% endif %}
            </header>

            <!-- Featured Image -->
            {% if post.featured_image %}
            <div class="text-center mb-4">
                <img src="{{ post.featured_image.url }}" 
                     class="img-fluid rounded shadow" 
                     alt="{{ post.title }}"
                     style="max-height: 500px; width: auto; cursor: pointer;"
                     onclick="openLightbox('{{ post.featured_image.url }}', '{{ post.title }}')">
            </div>
            {% endif %}
            
            <!-- Featured Video - FIXED VERSION -->
            {% if post.featured_video %}
            <div class="video-container mb-4">
                {% if 'youtube' in post.featured_video|lower %}
                    <!-- Handle YouTube URLs -->
                    {% with url=post.featured_video %}
                        {% if 'watch?v=' in url %}
                            <iframe src="https://www.youtube.com/embed/{{ url|cut:'https://www.youtube.com/watch?v='|cut:'http://www.youtube.com/watch?v='|cut:'&' }}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        {% elif 'youtu.be/' in url %}
                            <iframe src="https://www.youtube.com/embed/{{ url|cut:'https://youtu.be/'|cut:'http://youtu.be/' }}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        {% elif 'embed/' in url %}
                            <iframe src="{{ url }}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        {% else %}
                            <!-- Assume it's just the video ID -->
                            <iframe src="https://www.youtube.com/embed/{{ url }}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        {% endif %}
                    {% endwith %}
                {% elif 'vimeo' in post.featured_video|lower %}
                    <!-- Handle Vimeo URLs -->
                    {% with url=post.featured_video %}
                        <iframe src="https://player.vimeo.com/video/{{ url|cut:'https://vimeo.com/'|cut:'http://vimeo.com/' }}" 
                                frameborder="0" 
                                allow="autoplay; fullscreen; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                    {% endwith %}
                {% else %}
                    <!-- Direct embed URL -->
                    <iframe src="{{ post.featured_video }}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                    </iframe>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Post Content -->
            <div class="blog-content mb-5">
                {{ post.content|safe|linebreaks }}
            </div>
            
            <!-- Additional Images Gallery -->
            {% if post.images.all %}
            <h3 class="mb-4" style="color: #2d5a3b;">
                <i class="fas fa-images" style="color: #ffd966; margin-right: 10px;"></i>
                Image Gallery
            </h3>
            <div class="media-gallery">
                {% for image in post.images.all %}
                <div class="gallery-item">
                    <img src="{{ image.image.url }}" 
                         alt="{{ image.caption|default:post.title }}"
                         class="gallery-image"
                         onclick="openLightbox('{{ image.image.url }}', '{{ image.caption|default:post.title }}')">
                    {% if image.caption %}
                    <div class="gallery-caption">{{ image.caption }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Additional Videos - FIXED VERSION -->
            {% if post.videos.all %}
            <h3 class="mb-4" style="color: #2d5a3b;">
                <i class="fas fa-video" style="color: #ffd966; margin-right: 10px;"></i>
                Videos
            </h3>
            {% for video in post.videos.all %}
            <div class="video-item">
                <h5 class="video-title">{{ video.title }}</h5>
                {% if video.description %}
                <p class="video-description">{{ video.description }}</p>
                {% endif %}
                <div class="video-container">
                    {% if 'youtube' in video.video_url|lower %}
                        {% with url=video.video_url %}
                            {% if 'watch?v=' in url %}
                                <iframe src="https://www.youtube.com/embed/{{ url|cut:'https://www.youtube.com/watch?v='|cut:'http://www.youtube.com/watch?v='|cut:'&' }}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                </iframe>
                            {% elif 'youtu.be/' in url %}
                                <iframe src="https://www.youtube.com/embed/{{ url|cut:'https://youtu.be/'|cut:'http://youtu.be/' }}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                </iframe>
                            {% elif 'embed/' in url %}
                                <iframe src="{{ url }}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                </iframe>
                            {% else %}
                                <iframe src="https://www.youtube.com/embed/{{ url }}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                </iframe>
                            {% endif %}
                        {% endwith %}
                    {% elif 'vimeo' in video.video_url|lower %}
                        {% with url=video.video_url %}
                            <iframe src="https://player.vimeo.com/video/{{ url|cut:'https://vimeo.com/'|cut:'http://vimeo.com/' }}" 
                                    frameborder="0" 
                                    allow="autoplay; fullscreen; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        {% endwith %}
                    {% else %}
                        <iframe src="{{ video.video_url }}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}
            
            <!-- Downloadable Files -->
            {% if post.files.all %}
            <div class="files-section">
                <h3 class="mb-4" style="color: #2d5a3b;">
                    <i class="fas fa-download" style="color: #ffd966; margin-right: 10px;"></i>
                    Resources & Downloads
                </h3>
                {% for file in post.files.all %}
                <div class="file-download">
                    <div class="file-icon">
                        {% if file.file_type == 'pdf' %}
                            <i class="fas fa-file-pdf"></i>
                        {% elif file.file_type == 'doc' %}
                            <i class="fas fa-file-word"></i>
                        {% elif file.file_type == 'xls' %}
                            <i class="fas fa-file-excel"></i>
                        {% elif file.file_type == 'ppt' %}
                            <i class="fas fa-file-powerpoint"></i>
                        {% elif file.file_type == 'txt' %}
                            <i class="fas fa-file-alt"></i>
                        {% else %}
                            <i class="fas fa-file"></i>
                        {% endif %}
                    </div>
                    <div class="file-info">
                        <div class="file-title">{{ file.title }}</div>
                        <div class="file-meta">
                            <span><i class="fas fa-tag"></i> {{ file.get_file_type_display }}</span>
                            <span><i class="fas fa-database"></i> {{ file.file_size }}</span>
                            <span><i class="fas fa-download"></i> {{ file.downloads }} downloads</span>
                        </div>
                    </div>
                    <a href="{{ file.file.url }}" class="download-btn" download>
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Tags -->
            {% if post.tags.all %}
            <div class="mb-4">
                <h5 style="color: #2d5a3b;">Tags:</h5>
                {% for tag in post.tags.all %}
                <a href="{% url 'blog:tag_list' tag.slug %}" class="badge text-decoration-none me-1 mb-1" style="background-color: #2d5a3b; color: white; padding: 5px 10px;">
                    <i class="fas fa-tag"></i> {{ tag.name }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Share Buttons -->
            <div class="mb-5">
                <h5 style="color: #2d5a3b;">Share this post:</h5>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                   target="_blank" 
                   class="btn btn-sm me-1 mb-1"
                   style="background-color: #3b5998; color: white;">
                    <i class="fab fa-facebook-f"></i> Facebook
                </a>
                <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ post.title }}" 
                   target="_blank" 
                   class="btn btn-sm me-1 mb-1"
                   style="background-color: #1DA1F2; color: white;">
                    <i class="fab fa-twitter"></i> Twitter
                </a>
                <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri }}" 
                   target="_blank" 
                   class="btn btn-sm me-1 mb-1"
                   style="background-color: #0077b5; color: white;">
                    <i class="fab fa-linkedin-in"></i> LinkedIn
                </a>
                <a href="https://wa.me/?text={{ post.title }} - {{ request.build_absolute_uri }}" 
                   target="_blank" 
                   class="btn btn-sm me-1 mb-1"
                   style="background-color: #25D366; color: white;">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div id="imageModal" class="modal" onclick="closeLightbox()">
    <span class="close" onclick="closeLightbox()">&times;</span>
    <img class="modal-content" id="modalImage">
    <div id="modalCaption" class="modal-caption"></div>
</div>

<script>
// Lightbox functionality
function openLightbox(imageUrl, caption) {
    document.getElementById('imageModal').style.display = 'block';
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('modalCaption').innerHTML = caption;
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    document.getElementById('imageModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLightbox();
    }
});

// Track file downloads
document.querySelectorAll('.download-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        console.log('File downloaded:', this.href);
    });
});
</script>
{% endblock %}